<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="ISO-8859-1">
<title>InamManagement</title>
<link
	href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
	rel="stylesheet">
	<link rel="stylesheet" href="/css/sidebar.css">
<style>
.employee-table, .task-table {
	margin-top: 1rem;
}
</style>
</head>
<body>
	<div th:if="${session.user != null}">
		<div th:if="${session.user.role == 'admin' }">
			<div class="sidebar">
				<img style="padding-bottom: 30px;" width="230" height="150"
					th:src="@{/aimg/logo.png}" alt=""> <br>
				<ul class="nav flex-column">
					<li class="nav-item"><img width="30" height="30"
						th:src="@{/aimg/search.png}" alt="Profile" /> <a
						class="nav-link active" th:href="@{/search?type=1}"
						data-target="profile">View Tenant</a></li>
					<li class="nav-item"><img width="30" height="30"
						th:src="@{/aimg/addicon.png}" alt="Add Tenant" /> <a
						class="nav-link" th:href="@{/addTenant}">Add Tenant</a></li>
					<li class="nav-item"><img width="30" height="30"
						th:src="@{/aimg/eb.png}" alt="EB Bill" /> <a class="nav-link"
						th:href="@{/search?type=2}" data-target="addEBBill">Add
							EB-Bill</a></li>
					<li class="nav-item"><img width="30" height="30"
						th:src="@{/aimg/visitor.png}" alt="Visitors" /> <a
						class="nav-link" th:href="@{/viewVisitor}" data-target="visitors">Visitors</a>
					</li>
					<li class="nav-item"><img width="30" height="30"
						th:src="@{/aimg/complain.png}" alt="Complains" /> <a
						class="nav-link" th:href="@{/complain}" data-target="complains">Complains</a>
					</li>
					<li class="nav-item"><img width="30" height="30"
						th:src="@{/aimg/chat.png}" alt="chat" /> <a class="nav-link"
						th:href="@{/chat}" data-target="chat">chat</a></li>
					<li class="nav-item"><img width="30" height="30"
						th:src="@{/aimg/event.png}" alt="Events" /> <a class="nav-link"
						th:href="@{/events}" data-target="addEvents">Add Events</a></li>
					<li class="nav-item"><img width="30" height="30"
						th:src="@{/aimg/logout.png}" alt="Logout" /> <a class="nav-link"
						th:href="@{/logout}">Log-Out</a></li>
				</ul>
			</div>
			<div class="content">
				<div class="container-fluid">
					<div class="container mt-5">
						<div th:if="${complaints == null || #lists.isEmpty(complaints)}">
							<div class="alert alert-info" role="alert">No complaints
								found.</div>
						</div>
						<div th:if="${complaints != null && !#lists.isEmpty(complaints)}">
							<table class="table table-bordered">
								<thead class="thead-dark">
									<tr>
										<th>Complaint Type</th>
										<th>Comments</th>
										<th>Complaint Date</th>
										<th>Status</th>
										<th>Floor No</th>
										<th>Door No</th>
										<th>Actions</th>
									</tr>
								</thead>
								<tbody>
									<tr th:each="complaint : ${complaints}">
										<td th:text="${complaint.complainType}"></td>
										<td th:text="${complaint.comments}"></td>
										<td th:text="${complaint.complainDate}"></td>
										<td th:text="${complaint.complainStatus}"></td>
										<td th:text="${complaint.floorNo}"></td>
										<td th:text="${complaint.doorNo}"></td>
										<td>
											<button class="btn btn-primary btn-sm"
												th:onclick="'showAssignWorkerModal(' + ${complaint.id} + ')'">Assign
												Worker</button>
											<button class="btn btn-success btn-sm"
												th:onclick="'updateComplaintStatus(' + ${complaint.id} + ', \'Completed\',\'deleteTask\')'">Mark
												as Completed</button>
										</td>
									</tr>
								</tbody>
							</table>
						</div>

						<!-- Modal for assigning worker -->
						<div class="modal fade" id="assignWorkerModal" tabindex="-1"
							aria-labelledby="assignWorkerModalLabel" aria-hidden="true">
							<div class="modal-dialog">
								<div class="modal-content">
									<div class="modal-header">
										<h5 class="modal-title" id="assignWorkerModalLabel">Assign
											Worker</h5>
										<button type="button" class="close" data-dismiss="modal"
											aria-label="Close">
											<span aria-hidden="true">&times;</span>
										</button>
									</div>
									<div class="modal-body">
										<form th:action="@{/assignWork}" method="post">
											<div class="form-group">
												<label for="workerSelect">Select Worker</label> <select
													class="form-control" id="workerSelect" name="workerId"
													required>
													<option value="" disabled selected>Select a worker</option>
													<option th:each="employee : ${employees}"
														th:value="${employee.id}"
														th:text="${employee.name + '(' + employee.department + ')'}"></option>
												</select>
											</div>
											<input type="hidden" id="currentComplaintId"
												name="complaintId"> <input type="hidden"
												name="action" value="assignWork">
											<button type="submit" class="btn btn-primary">Assign</button>
										</form>
									</div>
								</div>
							</div>
						</div>

						<!-- Button to toggle employee table -->
						<button class="btn btn-secondary btn-sm corner-toggle"
							onclick="toggleEmployeeTable()">
							<i class="fas fa-users"></i> Manage Employees
						</button>

						<!-- Employee Management Section -->
						<div class="corner bg-light border rounded" id="employeeSection"
							style="display: none;">
							<div class="container p-3">
								<h4 class="mb-3">Employee Management</h4>
								<button class="btn btn-primary btn-sm corner-btn"
									onclick="showAddEmployeeModal()">Add Employee</button>
								<div class="employee-table">
									<div th:if="${employees == null || #lists.isEmpty(employees)}">
										<div class="alert alert-info" role="alert">No employees
											found.</div>
									</div>
									<div th:if="${employees != null && !#lists.isEmpty(employees)}">
										<table class="table table-sm">
											<thead class="thead-dark">
												<tr>
													<th>Name</th>
													<th>Phone</th>
													<th>Dept</th>
													<th>Actions</th>
												</tr>
											</thead>
											<tbody>
												<tr th:each="employee : ${employees}">
													<td th:text="${employee.name}"></td>
													<td th:text="${employee.phoneNumber}"></td>
													<td th:text="${employee.department}"></td>
													<td>
														<button class="btn btn-danger btn-sm"
															th:onclick="'deleteEmployee(' + ${employee.id} + ',\'deleteEmployee\')'">Delete</button>
													</td>
												</tr>
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>

						<!-- Button to toggle task table -->
						<button class="btn btn-secondary btn-sm corner-toggle"
							onclick="toggleTaskTable()">
							<i class="fas fa-tasks"></i> Manage Tasks
						</button>

						<!-- Task Management Section -->
						<div class="corner bg-light border rounded" id="taskSection"
							style="display: none;">
							<div class="container p-3">
								<h4 class="mb-3">Task Management</h4>
								<div class="task-table">
									<div th:if="${tasks == null || #lists.isEmpty(tasks)}">
										<div class="alert alert-info" role="alert">No tasks
											found.</div>
									</div>
									<div th:if="${tasks != null && !#lists.isEmpty(tasks)}">
										<table class="table table-sm">
											<thead class="thead-dark">
												<tr>
													<th>Task</th>
													<th>Status</th>
												</tr>
											</thead>
											<tbody>
												<tr th:each="task : ${tasks}">
													<td th:text="${task.employeeId}"></td>
													<td th:text="${task.complainType}"></td>
													<td th:text="${task.complainStatus}"></td>
												</tr>
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>

						<!-- Modal for adding employee -->
						<div class="modal fade" id="addEmployeeModal" tabindex="-1"
							aria-labelledby="addEmployeeModalLabel" aria-hidden="true">
							<div class="modal-dialog">
								<div class="modal-content">
									<div class="modal-header">
										<h5 class="modal-title" id="addEmployeeModalLabel">Add
											Employee</h5>
										<button type="button" class="close" data-dismiss="modal"
											aria-label="Close">
											<span aria-hidden="true">&times;</span>
										</button>
									</div>
									<div class="modal-body">
										<form th:action="@{/addEmployee}" method="post">
											<div class="form-group">
												<label for="employeeName">Name</label> <input type="text"
													class="form-control" id="employeeName" name="name" required>
											</div>
											<div class="form-group">
												<label for="employeePhone">Phone</label> <input type="text"
													class="form-control" id="employeePhone" name="phoneNumber"
													required>
											</div>
											<div class="form-group">
												<label for="employeeDept">Department</label> <input
													type="text" class="form-control" id="employeeDept"
													name="department" required>
											</div>
											<button type="submit" class="btn btn-primary">Add</button>
										</form>
									</div>
								</div>
							</div>
						</div>

					</div>
				</div>
			</div>
		</div>
		<div th:if="${session.user.role == 'user'}">
			<div class="sidebar">
				<img style="padding-bottom: 30px;" width="230" height="150"
					th:src="@{/aimg/logo.png}" alt=""> <br>
				<ul class="nav flex-column">
					<li class="nav-item"><img width="30" height="30"
						th:src="@{/aimg/profileicon.png}" alt="Profile" /> <a
						class="nav-link active" th:href="@{/search?type=1}"
						data-target="profile">Profile</a></li>
					<li class="nav-item"><img width="30" height="30"
						th:src="@{/aimg/eb.png}" alt="EB Bill" /> <a class="nav-link"
						th:href="@{/payment}" data-target="addEBBill">payment</a></li>
					<li class="nav-item"><img width="30" height="30"
						th:src="@{/aimg/complain.png}" alt="Complains" /> <a
						class="nav-link" th:href="@{/complain}" data-target="complains">Complains</a>
					</li>
					<li class="nav-item"><img width="30" height="30"
						th:src="@{/aimg/chat.png}" alt="chat" /> <a class="nav-link"
						th:href="@{/chat}" data-target="chat">chat</a></li>
					<li class="nav-item"><img width="30" height="30"
						th:src="@{/aimg/event.png}" alt="Events" /> <a class="nav-link"
						th:href="@{/events}" data-target="addEvents">Events</a></li>
					<li class="nav-item"><img width="30" height="30"
						th:src="@{/aimg/logout.png}" alt="Logout" /> <a class="nav-link"
						th:href="@{/logout}" data-target="logout">Log-Out</a></li>
				</ul>
			</div>
			<div class="content">
				<div class="container-fluid">
					<div class="container mt-5">
						<div class="container">
							<h2 class="form-title text-primary">Raise a Complaint</h2>
							<form id="complaintForm" th:action="@{/addComplaint}"
								method="post">
								<div class="form-group">
									<label for="complainType">Complain Type</label> <select
										class="form-control" id="complainType" name="complainType"
										required>
										<option value="" disabled selected>Select complain
											type</option>
										<option value="Plumbing">Plumbing</option>
										<option value="Electrical">Electrical</option>
										<option value="HVAC">HVAC</option>
										<option value="Cleaning">Cleaning</option>
										<!-- Add more options kas needed -->
									</select>
								</div>
								<div class="form-group">
									<label for="comments">Comments</label>
									<textarea class="form-control" id="comments" name="comments"
										rows="3" placeholder="Describe your complaint..." required></textarea>
								</div>
								<div class="form-group">
									<label for="complainDate">Complain Date</label> <input
										type="date" class="form-control" id="complainDate"
										name="complainDate" required>
								</div>
								<input type="hidden" value="addTask" name="action">
								<button type="submit" class="btn btn-primary btn-block">Submit
									Complaint</button>
							</form>

							<div class="complaint-status">
								<button class="btn btn-secondary btn-block mt-4"
									onclick="toggleComplaintStatus()">View Complaint
									Status</button>
								<div id="complaintStatusTable" style="display: none;">
									<div th:if="${complaints == null || complaints.isEmpty()}"
										class="alert alert-info" role="alert">No complaints
										found.</div>
									<div th:if="${complaints != null && !complaints.isEmpty()}">
										<table class="table table-bordered">
											<thead class="thead-dark">
												<tr>
													<th>Complaint Type</th>
													<th>Comments</th>
													<th>Complaint Date</th>
													<th>Status</th>
													<th>Floor No</th>
													<th>Door No</th>
												</tr>
											</thead>
											<tbody>
												<tr th:each="complaint : ${complaints}">
													<td th:text="${complaint.complainType}">Complain Type</td>
													<td th:text="${complaint.comments}">Comments</td>
													<td th:text="${complaint.complainDate}">Complaint Date</td>
													<td th:text="${complaint.complainStatus}">Status</td>
													<td th:text="${complaint.floorNo}">Floor No</td>
													<td th:text="${complaint.doorNo}">Door No</td>
												</tr>
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div th:if="${session.user == null}">
		<h2>
			Please <a th:href="@{/login}">login</a> to continue.
		</h2>
	</div>

	<!-- Include Bootstrap JS and dependencies -->
	<!-- Scripts -->
	<script src="https://kit.fontawesome.com/a076d05399.js"></script>
	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
	<script
		src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

	<script th:inline="javascript">
		function toggleComplaintStatus(){
			$('#complaintStatusTable').toggle('show');
		}
		function showAssignWorkerModal(complaintId) {
			$('#currentComplaintId').val(complaintId);
			$('#assignWorkerModal').modal('show');
		}
		function showAddEmployeeModal() {
			$('#addEmployeeModal').modal('show');
		}
		function toggleEmployeeTable() {
			$('#employeeSection').toggle();
		}

		function toggleTaskTable() {
			$('#taskSection').toggle();
		}

		function updateComplaintStatus(complaintId, status, action) {
			if (confirm('Are you sure you want to mark this complaint as completed?')) {
				window.location.href = /*[[@{/updateComplaintStatus}]]*/'/updateComplaintStatus'
						+ '?id='
						+ complaintId
						+ '&status='
						+ status
						+ '&action=' + action;
			}
		}
		function deleteEmployee(employeeId, action) {
			if (confirm('Are you sure you want to delete this employee?')) {
				$.ajax({
					url : '/deleteEmployee',
					type : 'POST',
					data : {
						employeeId : employeeId,
						action : action
					},
					success : function(response) {
						alert('Employee deleted successfully');
						location.reload();
					},
					error : function(xhr, status, error) {
						alert('Failed to delete employee: ' + error);
					}
				});
			}
		}
		function updateComplaintStatus(complaintId, status,action) {
        	$.ajax({
                url: '/deleteTask',
                type: 'POST',
                data: { complaintId: complaintId,status: status,action: action },
                success: function(response) {
                    alert('Task deleted successfully');
                    location.reload();
                },
                error: function(xhr, status, error) {
                    alert('Failed to delete Task: ' + error);
                }
            });
        }
	</script>
</body>
</html>
